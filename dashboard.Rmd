---
title: "Global Terrorism Analysis (1970 - 2015)"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    orientation: rows
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyr)
library(dplyr)
library(maps)
library(ggmap)
library(shiny)
library(plotly)
```

```{r}
#source files
source ('./functions/dataImport.R', local = T)
source ('./functions/attacksOverYears.R', local = T)
source ('./functions/casualtiesOverYears.R', local = T)
source ('./functions/highCasualtyFactor.R', local = T)
source('./functions/mostAttackedCountries.R', local = T)
source('./functions/visualizeCountMap.R', local = T)
```

```{r}
terr <- dataImport()
world <- map_data("world")
```

```{r results='hide'}
#for UTF-8 encoding
Sys.setlocale('LC_ALL','C')
```

Sidebar {.sidebar}
=======================================================================
```{r}
# year slider input for reactive map
sliderInput('yearRange', 'Year Range',
            min = min(terr$year), max = max(terr$year),
            value = c(min(terr$year), max(terr$year)),
            step = 1, sep = "")

#country drop down input for yearly trend
selectInput('selectCountry', 'Select Country',
            choices = terr$nation)

```


General Figures
=======================================================================

Row
-----------------------------------------------------------------------

### Years of data

```{r}
years <- terr$year %>%
  max() -
terr$year %>%
  min()

valueBox(years, icon = "ion-calendar")
```

### Total Attacks

```{r}
terr %>%
  summarise(n()) %>%
  valueBox(icon = "ion-nuclear", color = 'orange')
```

### Total Casualties

```{r}
terr %>%
  summarise(sum(casualties)) %>%
  valueBox(icon = "ion-people", color = 'red')
```

Row {.tabset}
-----------------------------------------------------------------------

### Attacks around the world

```{r}
#startYear <- reactive(as.integer(input$yearRange[1]))
#endYear <- reactive(as.integer(input$yearRange[2]))


renderPlot({
  terr %>%
    filter(year >= input$yearRange[1], 
           year <= input$yearRange[2]) %>%
    group_by(nation) %>%
    summarise(Total=n()) %>%
    visualizeCountMap(world, "Number of terrorist attacks around the world")})
```

### Casualties around the world

```{r}
renderPlot({
terr %>%
    filter(year >= input$yearRange[1], 
           year <= input$yearRange[2]) %>%
    group_by(nation) %>%
    summarise(Total = sum(casualties)) %>%
    visualizeCountMap(world, "Number of Casualties around the world")})
```

Row
-----------------------------------------------------------------------

### Attacks over years

```{r}
renderPlot({terr %>%
    filter(year >= input$yearRange[1], 
           year <= input$yearRange[2]) %>%
    attacksOverYears()})
```

### Casualties over years

```{r}
renderPlot({terr %>%
    filter(year >= input$yearRange[1], 
           year <= input$yearRange[2]) %>%
    casualtiesOverYears()})
```

Factors
=======================================================================

Row
-----------------------------------------------------------------------

### Most Used Weapon

```{r}
terr %>%
  group_by(weapon) %>%
  summarise(n()) %>%
  top_n(1) %>%
  pull('weapon') %>%
  valueBox(icon = "ion-nuclear")
```

### Most Active Group

```{r}
terr %>%
  filter(gname != 'Unknown') %>%
  group_by(gname) %>%
  summarise(n()) %>%
  top_n(1) %>%
  pull('gname') %>%
  valueBox(icon = 'ion-people')
```


Row {.tabset}
-----------------------------------------------------------------------

### High Casualty Attacks

```{r}
n = 10

terr[c('target1', 'casualties')] %>%
  top_n(n, casualties) %>% 
  mutate(target1 = forcats::fct_reorder(target1, -casualties)) %>%
  highCasualtyFactor('target1', 'casualties', 
                     xlab = 'Attack Target', ylab = 'Casualty Count')
```

### High Casualty Terrorist Groups

```{r}
terr[c('gname', 'casualties')]%>%
  filter(gname!='Unknown') %>%
  group_by(gname) %>%
  summarise(casualties=n()) %>%
  top_n(n, casualties) %>%
  mutate(gname = forcats::fct_reorder(gname, -casualties)) %>%
  highCasualtyFactor('gname', 'casualties', 
                     xlab = 'Terrorist Group', ylab = 'Casualty Count')
```

### Most Attacked Countries

```{r}
terr['nation'] %>%
  group_by(nation) %>%
  summarise(Total=n()) %>%
  top_n(n, Total) %>%
  mutate(nation = forcats::fct_reorder(nation, -Total)) %>%
  highCasualtyFactor('nation', 'Total', 
                     xlab = 'Country', ylab = 'Attacks Count')
```